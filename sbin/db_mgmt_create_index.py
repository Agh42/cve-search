#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Script to check and ensure that the recommended index are created as recommended.
#
# Software is free software released under the "GNU Affero General Public License v3.0"
#
# Copyright (c) 2014       psychedelys
# Copyright (c) 2015-2018  Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

from pymongo import TEXT

import lib.DatabaseLayer as dbLayer

def setIndex(col, field, printSuccess = True):
    try:
        dbLayer.ensureIndex(col, field)
        if printSuccess:
            print('[+]Success to create index %s on %s' % (field, col))
    except Exception as e:
        print('[-]Failed to create index %s on %s: %s' % (col, field, e))

setIndex('cpe', 'id') # NOTE: was missing during first 'db_updater.py -v'. Collection gets dropped maybe?
setIndex('cpe', 'vendor') # added downstream
setIndex('cpe', 'product') # added downstream

setIndex('cpeother', 'id')

setIndex('cves', 'id')
setIndex('cves', 'vulnerable_configuration')
setIndex('cves', 'vulnerable_product')
setIndex('cves', 'Modified')
setIndex('cves', 'Published')
setIndex('cves', [("summary",TEXT)])
setIndex('cves', 'vendors') # added downstream
setIndex('cves', 'products') # added downstream
setIndex('cves', '{"cvss":1, "vulnerable_product":1}') # added downstream
setIndex('cves', '{"products":1, "Published":1}') # added downstream
setIndex('cves', '{"vulnerable_product_stems":1, "Published":1}') # added downstream
setIndex('cves', '{"vulnerable_configuration_stems":1, "Published":1}') # added downstream
setIndex('cves', 'vulnerable_product_stems') # added downstream
setIndex('cves', 'vulnerable_configuration_stems') # added downstream

setIndex('via4', 'id')
setIndex('mgmt_whitelist', 'id')
setIndex('mgmt_blacklist', 'id')
setIndex('capec', 'related_weakness')


via4 = dbLayer.getInfo('via4')
if via4:
    for index in via4.get('searchables', []):
        setIndex('via4', index, False)
